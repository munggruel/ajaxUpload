(function(e){var t={url:"upload.php",needCompress:true,onChange:function(e){return true},onSubmit:function(e){},onProgress:function(e){},onComplete:function(e,t,a){},onError:function(e){}};e.fn.ajaxFileUpload=function(a){a=e.extend({},t,a);var n=Math.round((new Date).getTime()/1e3);return this.each(function(){var t=e(this);if(t.is("input")&&t.attr("type")==="file"){t.bind("change",r)}});function r(t){var r=e(this).val().replace(/.*(\/|\\)/,"");if(!a.onChange(r)){e(this).val("");return false}if(window.applicationCache){if(a.needCompress&&/(.jpg|.png|.jpeg)$/.test(r.toLowerCase())){var f=window.URL||window.webkitURL,s=f.createObjectURL(this.files[0]),c=new Image;if(!a.onChange(r)){e(this).val("");return false}c.src=s;c.onload=function(){var t=this;var n=t.width,o=t.height,i=n/o;n=a.width||n;o=n/i;var f=document.createElement("canvas");var s=f.getContext("2d");e(f).attr({width:n,height:o});s.drawImage(t,0,0,n,o);base64=f.toDataURL("image/jpeg",a.quality||.9);if(navigator.userAgent.match(/iphone/i)){var d=new MegaPixImage(c);d.render(f,{maxWidth:n,maxHeight:o,quality:a.quality||.9});base64=f.toDataURL("image/jpeg",a.quality||.9)}if(navigator.userAgent.match(/Android/i)){var u=new JPEGEncoder;base64=u.encode(s.getImageData(0,0,n,o),a.quality*100||80)}e(this).ajaxFormSubmit(a,{base64:base64,filename:r},r)}}else{var d=new FormData;d.append(e(this).attr("name"),e(this)[0].files[0]);d.append("filename",r);e(this).ajaxFormSubmit(a,d,r)}}else{var u=e(t.target),h=u.attr("id"),l=u.removeAttr("id").clone().attr("id",h).ajaxFileUpload(a);var m="ajaxUploader-iframe-"+n;e("body").append('<iframe src="javascript:false;" name="'+m+'" id="'+m+'" style="display: none;"></iframe>');var g=e("#"+m),w=e("<form />").attr({method:"post",action:a.url,enctype:"multipart/form-data",target:g[0].name}).hide().appendTo("body");l.insertBefore(u);g.bind("load",{element:l,form:w,filename:r},o);g.bind("error",{element:l,form:w,filename:r},i);a.onSubmit(r);w.append(u).submit()}e(this).val("")}function o(t){var n=e(t.target),r=(n[0].contentWindow||n[0].contentDocument).document;var o=r.body.innerHTML?e.parseResponse(r.body.innerHTML):{};a.onComplete(o,t.data.filename);e(t.data.form).html("").remove();n.unbind().html("").remove()}function i(e){a.onError(e.data.filename)}};e.fn.ajaxFormSubmit=function(t,a,n){var r={xhr:function(){var e=new window.XMLHttpRequest;e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=parseInt(e.loaded/e.total*100);t.onProgress(a)}});return e},url:t.url,type:"POST",data:a,timeout:45e3,error:function(){t.onError(n)},success:function(r){r=e.parseResponse(r);t.onComplete(r,n,a.base64)}};if(typeof a.base64==="undefined"){r.processData=false;r.contentType=false}t.onSubmit(n);e.ajax(r)}})(jQuery);function JPEGEncoder(e){function t(e){var t,a,n,r,o,i,f,s,c,d=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99];for(t=0;64>t;t++)a=b((d[t]*e+50)/100),1>a?a=1:a>255&&(a=255),y[B[t]]=a;for(n=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],r=0;64>r;r++)o=b((n[r]*e+50)/100),1>o?o=1:o>255&&(o=255),L[B[r]]=o;for(i=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],f=0,s=0;8>s;s++)for(c=0;8>c;c++)I[f]=1/(8*y[B[f]]*i[s]*i[c]),j[f]=1/(8*L[B[f]]*i[s]*i[c]),f++}function a(e,t){var a,n,r=0,o=0,i=new Array;for(a=1;16>=a;a++){for(n=1;n<=e[a];n++)i[t[o]]=[],i[t[o]][0]=r,i[t[o]][1]=a,o++,r++;r*=2}return i}function n(){x=a(N,G),C=a(_,z),R=a(J,Q),A=a(X,$)}function r(){var e,t,a,n=1,r=2;for(e=1;15>=e;e++){for(t=n;r>t;t++)E[32767+t]=e,U[32767+t]=[],U[32767+t][1]=e,U[32767+t][0]=t;for(a=-(r-1);-n>=a;a++)E[32767+a]=e,U[32767+a]=[],U[32767+a][1]=e,U[32767+a][0]=r-1+a;n<<=1,r<<=1}}function o(){for(var e=0;256>e;e++)W[e]=19595*e,W[e+256>>0]=38470*e,W[e+512>>0]=7471*e+32768,W[e+768>>0]=-11059*e,W[e+1024>>0]=-21709*e,W[e+1280>>0]=32768*e+8421375,W[e+1536>>0]=-27439*e,W[e+1792>>0]=-5329*e}function i(e){for(var t=e[0],a=e[1]-1;a>=0;)t&1<<a&&(k|=1<<T),a--,T--,0>T&&(255==k?(f(255),f(0)):f(k),T=7,k=0)}function f(e){P.push(F[e])}function s(e){f(255&e>>8),f(255&e)}function c(e,t){var a,n,r,o,i,f,s,c,d,u,h,l,m,g,w,v,p,b,y,L,I,j,x,C,R,A,U,E,D,P,k,T,H,S,q,F,W,O,B,N,G,J,Q,_,z,X,$,K,V=0;var Y=8,Z=64;for(d=0;Y>d;++d)a=e[V],n=e[V+1],r=e[V+2],o=e[V+3],i=e[V+4],f=e[V+5],s=e[V+6],c=e[V+7],u=a+c,h=a-c,l=n+s,m=n-s,g=r+f,w=r-f,v=o+i,p=o-i,b=u+v,y=u-v,L=l+g,I=l-g,e[V]=b+L,e[V+4]=b-L,j=.707106781*(I+y),e[V+2]=y+j,e[V+6]=y-j,b=p+w,L=w+m,I=m+h,x=.382683433*(b-I),C=.5411961*b+x,R=1.306562965*I+x,A=.707106781*L,U=h+A,E=h-A,e[V+5]=E+C,e[V+3]=E-C,e[V+1]=U+R,e[V+7]=U-R,V+=8;for(V=0,d=0;Y>d;++d)a=e[V],n=e[V+8],r=e[V+16],o=e[V+24],i=e[V+32],f=e[V+40],s=e[V+48],c=e[V+56],D=a+c,P=a-c,k=n+s,T=n-s,H=r+f,S=r-f,q=o+i,F=o-i,W=D+q,O=D-q,B=k+H,N=k-H,e[V]=W+B,e[V+32]=W-B,G=.707106781*(N+O),e[V+16]=O+G,e[V+48]=O-G,W=F+S,B=S+T,N=T+P,J=.382683433*(W-N),Q=.5411961*W+J,_=1.306562965*N+J,z=.707106781*B,X=P+z,$=P-z,e[V+40]=$+Q,e[V+24]=$-Q,e[V+8]=X+_,e[V+56]=X-_,V++;for(d=0;Z>d;++d)K=e[d]*t[d],M[d]=K>0?0|K+.5:0|K-.5;return M}function d(){s(65504),s(16),f(74),f(70),f(73),f(70),f(0),f(1),f(1),f(0),s(1),s(1),f(0),f(0)}function u(e,t){s(65472),s(17),f(8),s(t),s(e),f(3),f(1),f(17),f(0),f(2),f(17),f(1),f(3),f(17),f(1)}function h(){var e,t;for(s(65499),s(132),f(0),e=0;64>e;e++)f(y[e]);for(f(1),t=0;64>t;t++)f(L[t])}function l(){var e,t,a,n,r,o,i,c;for(s(65476),s(418),f(0),e=0;16>e;e++)f(N[e+1]);for(t=0;11>=t;t++)f(G[t]);for(f(16),a=0;16>a;a++)f(J[a+1]);for(n=0;161>=n;n++)f(Q[n]);for(f(1),r=0;16>r;r++)f(_[r+1]);for(o=0;11>=o;o++)f(z[o]);for(f(17),i=0;16>i;i++)f(X[i+1]);for(c=0;161>=c;c++)f($[c])}function m(){s(65498),s(12),f(3),f(1),f(0),f(2),f(17),f(3),f(17),f(0),f(63),f(0)}function g(e,t,a,n,r){var o,f,s,d,u,h,l,m,g,w,v=r[0],p=r[240];var b=16,y=63,L=64;for(f=c(e,t),s=0;L>s;++s)D[B[s]]=f[s];for(d=D[0]-a,a=D[0],0==d?i(n[0]):(o=32767+d,i(n[E[o]]),i(U[o])),u=63;u>0&&0==D[u];u--);if(0==u)return i(v),a;for(h=1;u>=h;){for(m=h;0==D[h]&&u>=h;++h);if(g=h-m,g>=b){for(l=g>>4,w=1;l>=w;++w)i(p);g=15&g}o=32767+D[h],i(r[(g<<4)+E[o]]),i(U[o]),h++}return u!=y&&i(v),a}function w(){var e,t=String.fromCharCode;for(e=0;256>e;e++)F[e]=t(e)}function v(e){if(0>=e&&(e=1),e>100&&(e=100),O!=e){var a=0;a=50>e?Math.floor(5e3/e):Math.floor(200-2*e),t(a),O=e,console.log("Quality set to: "+e+"%")}}function p(){var t,a=(new Date).getTime();e||(e=50),w(),n(),r(),o(),v(e),t=(new Date).getTime()-a,console.log("Initialization "+t+"ms")}var b,y,L,I,j,x,C,R,A,U,E,M,D,P,k,T,H,S,q,F,W,O,B,N,G,J,Q,_,z,X,$;Math.round,b=Math.floor,y=new Array(64),L=new Array(64),I=new Array(64),j=new Array(64),U=new Array(65535),E=new Array(65535),M=new Array(64),D=new Array(64),P=[],k=0,T=7,H=new Array(64),S=new Array(64),q=new Array(64),F=new Array(256),W=new Array(2048),B=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],N=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],G=[0,1,2,3,4,5,6,7,8,9,10,11],J=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],Q=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],_=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],z=[0,1,2,3,4,5,6,7,8,9,10,11],X=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],$=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250],this.encode=function(e,t){var a,n,r,o,f,c,w,p,b,y,L,U,E,M,D,F,O,B,N,G,J=(new Date).getTime();for(t&&v(t),P=new Array,k=0,T=7,s(65496),d(),h(),u(e.width,e.height),l(),m(),a=0,n=0,r=0,k=0,T=7,this.encode.displayName="_encode_",o=e.data,f=e.width,c=e.height,w=4*f,b=0;c>b;){for(p=0;w>p;){for(E=w*b+p,M=E,D=-1,F=0,O=0;64>O;O++)F=O>>3,D=4*(7&O),M=E+F*w+D,b+F>=c&&(M-=w*(b+1+F-c)),p+D>=w&&(M-=p+D-w+4),y=o[M++],L=o[M++],U=o[M++],H[O]=(W[y]+W[L+256>>0]+W[U+512>>0]>>16)-128,S[O]=(W[y+768>>0]+W[L+1024>>0]+W[U+1280>>0]>>16)-128,q[O]=(W[y+1280>>0]+W[L+1536>>0]+W[U+1792>>0]>>16)-128;a=g(H,I,a,x,R),n=g(S,j,n,C,A),r=g(q,j,r,C,A),p+=32}b+=8}return T>=0&&(B=[],B[1]=T+1,B[0]=(1<<T+1)-1,i(B)),s(65497),N="data:image/jpeg;base64,"+btoa(P.join("")),P=[],G=(new Date).getTime()-J,console.log("Encoding time: "+G+"ms"),N},p()}function getImageDataFromImage(e){var t,a="string"==typeof e?document.getElementById(e):e,n=document.createElement("canvas");return n.width=a.width,n.height=a.height,t=n.getContext("2d"),t.drawImage(a,0,0),t.getImageData(0,0,n.width,n.height)}!function(){function e(e){var t,a,n=e.naturalWidth,r=e.naturalHeight;return n*r>1048576?(t=document.createElement("canvas"),t.width=t.height=1,a=t.getContext("2d"),a.drawImage(e,-n+1,0),0===a.getImageData(0,0,1,1).data[3]):!1}function t(e,t,a){var n,r,o,i,f,s,c,d=document.createElement("canvas");for(d.width=1,d.height=a,n=d.getContext("2d"),n.drawImage(e,0,0),r=n.getImageData(0,0,1,a).data,o=0,i=a,f=a;f>o;)s=r[4*(f-1)+3],0===s?i=f:o=f,f=i+o>>1;return c=f/a,0===c?1:c}function a(e,t,a){var r=document.createElement("canvas");return n(e,r,t,a),r.toDataURL("image/jpeg",t.quality||.8)}function n(a,n,o,i){var f,s,c,d,u,h,l,m,g,w,v,p=a.naturalWidth,b=a.naturalHeight,y=o.width,L=o.height,I=n.getContext("2d");for(I.save(),r(n,I,y,L,o.orientation),f=e(a),f&&(p/=2,b/=2),s=1024,c=document.createElement("canvas"),c.width=c.height=s,d=c.getContext("2d"),u=i?t(a,p,b):1,h=Math.ceil(s*y/p),l=Math.ceil(s*L/b/u),m=0,g=0;b>m;){for(w=0,v=0;p>w;)d.clearRect(0,0,s,s),d.drawImage(a,-w,-m),I.drawImage(c,0,0,s,s,v,g,h,l),w+=s,v+=h;m+=s,g+=l}I.restore(),c=d=null}function r(e,t,a,n,r){switch(r){case 5:case 6:case 7:case 8:e.width=n,e.height=a;break;default:e.width=a,e.height=n}switch(r){case 2:t.translate(a,0),t.scale(-1,1);break;case 3:t.translate(a,n),t.rotate(Math.PI);break;case 4:t.translate(0,n),t.scale(1,-1);break;case 5:t.rotate(.5*Math.PI),t.scale(1,-1);break;case 6:t.rotate(.5*Math.PI),t.translate(0,-n);break;case 7:t.rotate(.5*Math.PI),t.translate(a,-n),t.scale(-1,1);break;case 8:t.rotate(-.5*Math.PI),t.translate(-a,0)}}function o(e){var t,a,n;if(window.Blob&&e instanceof Blob){if(t=new Image,a=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null,!a)throw Error("No createObjectURL function found to create blob url");t.src=a.createObjectURL(e),this.blob=e,e=t}e.naturalWidth||e.naturalHeight||(n=this,e.onload=function(){var e,t,a=n.imageLoadListeners;if(a)for(n.imageLoadListeners=null,e=0,t=a.length;t>e;e++)a[e]()},this.imageLoadListeners=[]),this.srcImage=e}o.prototype.render=function(e,t,r){var o,i,f,s,c,d,u,h,l,m,g;if(this.imageLoadListeners)return o=this,this.imageLoadListeners.push(function(){o.render(e,t,r)}),void 0;t=t||{},i=this.srcImage.naturalWidth,f=this.srcImage.naturalHeight,s=t.width,c=t.height,d=t.maxWidth,u=t.maxHeight,h=!this.blob||"image/jpeg"===this.blob.type,s&&!c?c=f*s/i<<0:c&&!s?s=i*c/f<<0:(s=i,c=f),d&&s>d&&(s=d,c=f*s/i<<0),u&&c>u&&(c=u,s=i*c/f<<0),l={width:s,height:c};for(m in t)l[m]=t[m];g=e.tagName.toLowerCase(),"img"===g?e.src=a(this.srcImage,l,h):"canvas"===g&&n(this.srcImage,e,l,h),"function"==typeof this.onrender&&this.onrender(e),r&&r()},"function"==typeof define&&define.amd?define([],function(){return o}):this.MegaPixImage=o}();